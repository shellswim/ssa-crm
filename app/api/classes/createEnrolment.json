{
  "meta": {
    "$_GET": [
      {
        "type": "text",
        "name": "isvalid"
      },
      {
        "type": "number",
        "name": "familyid"
      },
      {
        "type": "boolean",
        "name": "chargeahead"
      },
      {
        "type": "text",
        "name": "sort"
      },
      {
        "type": "text",
        "name": "dir"
      },
      {
        "type": "text",
        "name": "userid"
      },
      {
        "type": "text",
        "ui": {
          "input": "date"
        },
        "name": "duedate"
      }
    ],
    "$_POST": [
      {
        "type": "number",
        "name": "classId"
      },
      {
        "type": "date",
        "name": "startDate"
      },
      {
        "type": "date",
        "name": "dropDate"
      },
      {
        "type": "text",
        "name": "student"
      },
      {
        "type": "number",
        "name": "enrolmentType"
      },
      {
        "type": "boolean",
        "name": "isValid"
      },
      {
        "type": "date",
        "name": "dropDate || null"
      },
      {
        "type": "text",
        "name": "duedate"
      }
    ]
  },
  "exec": {
    "steps": [
      {
        "name": "",
        "module": "core",
        "action": "condition",
        "options": {
          "if": "{{!$_POST.duedate}}",
          "then": {
            "steps": "lib/families/ledger/tuition_checkCurrentPeriodExists"
          }
        },
        "outputType": "boolean"
      },
      {
        "name": "",
        "module": "core",
        "action": "condition",
        "options": {
          "if": "{{exists}}",
          "then": {
            "steps": {
              "name": "",
              "module": "core",
              "action": "trycatch",
              "options": {
                "try": {
                  "steps": [
                    {
                      "name": "insert",
                      "module": "dbupdater",
                      "action": "insert",
                      "options": {
                        "connection": "db",
                        "sql": {
                          "type": "insert",
                          "values": [
                            {
                              "table": "enrolments",
                              "column": "classId",
                              "type": "number",
                              "value": "{{$_POST.classId}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "startDate",
                              "type": "date",
                              "value": "{{$_POST.startDate}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "dropDate",
                              "type": "date",
                              "value": "{{$_POST.dropDate || null}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "student",
                              "type": "text",
                              "value": "{{$_POST.student}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "enrolmentType",
                              "type": "number",
                              "value": "{{$_POST.enrolmentType}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "isValid",
                              "type": "boolean",
                              "value": "{{$_GET.isvalid}}"
                            }
                          ],
                          "table": "enrolments",
                          "returning": "id",
                          "query": "INSERT INTO enrolments\n(classId, startDate, dropDate, student, enrolmentType, isValid) VALUES (:P1 /* {{$_POST.classId}} */, :P2 /* {{$_POST.startDate}} */, :P3 /* {{$_POST.dropDate || null}} */, :P4 /* {{$_POST.student}} */, :P5 /* {{$_POST.enrolmentType}} */, :P6 /* {{$_GET.isvalid}} */)",
                          "params": [
                            {
                              "name": ":P1",
                              "type": "expression",
                              "value": "{{$_POST.classId}}"
                            },
                            {
                              "name": ":P2",
                              "type": "expression",
                              "value": "{{$_POST.startDate}}"
                            },
                            {
                              "name": ":P3",
                              "type": "expression",
                              "value": "{{$_POST.dropDate || null}}"
                            },
                            {
                              "name": ":P4",
                              "type": "expression",
                              "value": "{{$_POST.student}}"
                            },
                            {
                              "name": ":P5",
                              "type": "expression",
                              "value": "{{$_POST.enrolmentType}}"
                            },
                            {
                              "name": ":P6",
                              "type": "expression",
                              "value": "{{$_GET.isvalid}}"
                            }
                          ]
                        }
                      },
                      "meta": [
                        {
                          "name": "identity",
                          "type": "text"
                        },
                        {
                          "name": "affected",
                          "type": "number"
                        }
                      ]
                    },
                    {
                      "name": "",
                      "module": "core",
                      "action": "condition",
                      "options": {
                        "if": "{{$_GET.chargeahead == true || $_GET.chargeahead == \"true\"}}",
                        "then": {
                          "steps": {
                            "name": "runalltuitioncharges",
                            "module": "core",
                            "action": "exec",
                            "options": {
                              "exec": "families/ledger/tuitionchargeahead",
                              "params": {
                                "startdate": "{{$_POST.startDate.formatDate('yyyy-MM-dd')}}",
                                "userid": "{{$_GET.userid}}",
                                "familyid": "{{$_GET.familyid}}"
                              }
                            },
                            "output": true
                          }
                        },
                        "else": {
                          "steps": [
                            {
                              "name": "singleTuitionCharge",
                              "module": "tuitioncalc",
                              "action": "tuitioncalc",
                              "options": {
                                "familyid": "{{$_GET.familyid}}",
                                "monthtoprocess": "{{$_POST.startDate.startMonth().formatDate('yyyy-MM-dd')}}"
                              },
                              "meta": [
                                {
                                  "name": "dates",
                                  "type": "array"
                                }
                              ]
                            },
                            {
                              "name": "runsinglecharge",
                              "module": "core",
                              "action": "exec",
                              "options": {
                                "exec": "families/ledger/tuitioncharge",
                                "params": {
                                  "charge": "{{singleTuitionCharge}}",
                                  "userid": "{{$_GET.userid}}",
                                  "familyid": "{{$_GET.familyid}}"
                                }
                              },
                              "output": true
                            }
                          ]
                        }
                      },
                      "outputType": "boolean"
                    }
                  ]
                },
                "catch": {
                  "steps": [
                    {
                      "name": "",
                      "module": "core",
                      "action": "response",
                      "options": {
                        "status": "{{$_ERROR}}",
                        "data": "{{$_ERROR}}"
                      }
                    },
                    {
                      "name": "delete",
                      "module": "dbupdater",
                      "action": "delete",
                      "options": {
                        "connection": "db",
                        "sql": {
                          "type": "delete",
                          "table": "enrolments",
                          "wheres": {
                            "condition": "AND",
                            "rules": [
                              {
                                "id": "id",
                                "field": "id",
                                "type": "double",
                                "operator": "equal",
                                "value": "{{insert.identity}}",
                                "data": {
                                  "column": "id"
                                },
                                "operation": "="
                              }
                            ],
                            "conditional": null,
                            "valid": true
                          },
                          "query": "DELETE\nFROM enrolments\nWHERE id = :P1 /* {{insert.identity}} */",
                          "params": [
                            {
                              "operator": "equal",
                              "type": "expression",
                              "name": ":P1",
                              "value": "{{insert.identity}}"
                            }
                          ]
                        }
                      },
                      "meta": [
                        {
                          "name": "affected",
                          "type": "number"
                        }
                      ]
                    }
                  ]
                }
              }
            }
          }
        },
        "outputType": "boolean"
      },
      {
        "name": "",
        "module": "core",
        "action": "condition",
        "options": {
          "if": "{{!exists}}",
          "then": {
            "steps": {
              "name": "",
              "module": "core",
              "action": "trycatch",
              "options": {
                "try": {
                  "steps": [
                    {
                      "name": "insert_enrol",
                      "module": "dbupdater",
                      "action": "insert",
                      "options": {
                        "connection": "db",
                        "sql": {
                          "type": "insert",
                          "values": [
                            {
                              "table": "enrolments",
                              "column": "classId",
                              "type": "number",
                              "value": "{{$_POST.classId}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "startDate",
                              "type": "date",
                              "value": "{{$_POST.startDate}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "dropDate",
                              "type": "date",
                              "value": "{{$_POST.dropDate || null}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "student",
                              "type": "text",
                              "value": "{{$_POST.student}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "enrolmentType",
                              "type": "number",
                              "value": "{{$_POST.enrolmentType}}"
                            },
                            {
                              "table": "enrolments",
                              "column": "isValid",
                              "type": "boolean",
                              "value": "{{$_GET.isvalid}}"
                            }
                          ],
                          "table": "enrolments",
                          "returning": "id",
                          "query": "INSERT INTO enrolments\n(classId, startDate, dropDate, student, enrolmentType, isValid) VALUES (:P1 /* {{$_POST.classId}} */, :P2 /* {{$_POST.startDate}} */, :P3 /* {{$_POST.dropDate || null}} */, :P4 /* {{$_POST.student}} */, :P5 /* {{$_POST.enrolmentType}} */, :P6 /* {{$_GET.isvalid}} */)",
                          "params": [
                            {
                              "name": ":P1",
                              "type": "expression",
                              "value": "{{$_POST.classId}}"
                            },
                            {
                              "name": ":P2",
                              "type": "expression",
                              "value": "{{$_POST.startDate}}"
                            },
                            {
                              "name": ":P3",
                              "type": "expression",
                              "value": "{{$_POST.dropDate || null}}"
                            },
                            {
                              "name": ":P4",
                              "type": "expression",
                              "value": "{{$_POST.student}}"
                            },
                            {
                              "name": ":P5",
                              "type": "expression",
                              "value": "{{$_POST.enrolmentType}}"
                            },
                            {
                              "name": ":P6",
                              "type": "expression",
                              "value": "{{$_GET.isvalid}}"
                            }
                          ]
                        }
                      },
                      "meta": [
                        {
                          "name": "identity",
                          "type": "text"
                        },
                        {
                          "name": "affected",
                          "type": "number"
                        }
                      ]
                    },
                    {
                      "name": "",
                      "module": "core",
                      "action": "condition",
                      "options": {
                        "if": "{{$_GET.chargeahead == true || $_GET.chargeahead == \"true\"}}",
                        "then": {
                          "steps": {
                            "name": "runalltuitioncharges_copy",
                            "module": "core",
                            "action": "exec",
                            "options": {
                              "exec": "families/ledger/tuitionchargeahead",
                              "params": {
                                "startdate": "{{$_POST.startDate.formatDate('yyyy-MM-dd')}}",
                                "userid": "{{$_GET.userid}}",
                                "familyid": "{{$_GET.familyid}}"
                              }
                            },
                            "output": true
                          }
                        },
                        "else": {
                          "steps": [
                            {
                              "name": "singleTuitionCharge_copy",
                              "module": "tuitioncalc",
                              "action": "tuitioncalc",
                              "options": {
                                "familyid": "{{$_GET.familyid}}",
                                "monthtoprocess": "{{$_POST.startDate.startMonth().formatDate('yyyy-MM-dd')}}"
                              },
                              "meta": [
                                {
                                  "name": "dates",
                                  "type": "array"
                                }
                              ]
                            },
                            {
                              "name": "runsinglecharge_copy",
                              "module": "core",
                              "action": "exec",
                              "options": {
                                "exec": "families/ledger/tuitioncharge",
                                "params": {
                                  "charge": "{{singleTuitionCharge}}",
                                  "userid": "{{$_GET.userid}}",
                                  "familyid": "{{$_GET.familyid}}",
                                  "dueDate": "{{$_GET.duedate}}",
                                  "chargeDate": "{{NOW_UTC.toLocalTime().formatDate('yyyy-MM-dd')}}"
                                }
                              },
                              "output": true
                            }
                          ]
                        }
                      },
                      "outputType": "boolean"
                    }
                  ]
                }
              }
            }
          }
        },
        "outputType": "boolean"
      }
    ]
  }
}